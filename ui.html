<!doctype html>
<html lang="en">
<head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Design Token Converter</title>
      <style>
        :root{
          --bg: #2c2c2c;
          --surface: #3a3a3a;
          --card: #404040;
          --muted: #9ca3af;
          --text: #ffffff;
          --panel: #353535;
          --input-border: #555555;
          --btn-bg: linear-gradient(90deg,#4f46e5,#7c3aed);
          --primary: #4f46e5;
          --success: #10b981;
          --danger: #ef4444;
          --glass: rgba(255,255,255,0.1);
        }
        [data-theme='light']{
          --bg: #ffffff;
          --surface: #f7f9fc;
          --card: #ffffff;
          --muted: #6b7280;
          --text: #111827;
          --panel: #f3f4f6;
          --input-border: #d1d5db;
          --btn-bg: linear-gradient(90deg,#4f46e5,#7c3aed);
          --primary: #4f46e5;
          --success: #059669;
          --danger: #dc2626;
          --glass: rgba(0,0,0,0.05);
        }

        *{ box-sizing: border-box; margin: 0; padding: 0; }
        html,body{ height:100%; }
        body{ 
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
          background: var(--bg); 
          color: var(--text); 
          padding: 16px;
        }

        .container{ 
          width: 100%; 
          max-width: 380px; 
          margin: 0 auto; 
        }

        .header{ 
          display: flex; 
          align-items: center; 
          justify-content: space-between;
          margin-bottom: 24px;
          padding: 16px 0;
        }

        .logo-section {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .logo{ 
          width: 40px; 
          height: 40px; 
          border-radius: 8px; 
          background: var(--btn-bg); 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          color: white; 
          font-weight: 700; 
          font-size: 16px;
        }

        .title-section {
          display: flex;
          flex-direction: column;
        }

        .h-title{ 
          font-size: 18px; 
          font-weight: 600;
          color: var(--text);
        }

        .h-sub{ 
          font-size: 12px; 
          color: var(--muted);
          margin-top: 2px;
        }

        .header-actions {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .theme-toggle {
          width: 32px;
          height: 32px;
          border-radius: 6px;
          background: var(--card);
          border: 1px solid var(--input-border);
          color: var(--text);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
        }

        .close-btn {
          width: 32px;
          height: 32px;
          border-radius: 6px;
          background: var(--card);
          border: 1px solid var(--input-border);
          color: var(--text);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
        }

        .drop-zone {
          background: var(--card);
          border: 2px dashed var(--input-border);
          border-radius: 12px;
          padding: 40px 20px;
          text-align: center;
          margin-bottom: 24px;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .drop-zone:hover {
          border-color: var(--primary);
          background: var(--surface);
        }

        .drop-zone h3 {
          font-size: 16px;
          font-weight: 600;
          margin-bottom: 8px;
          color: var(--text);
        }

        .drop-zone p {
          font-size: 14px;
          color: var(--muted);
          margin-bottom: 16px;
        }

        .choose-btn {
          background: var(--surface);
          border: 1px solid var(--input-border);
          color: var(--text);
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
        }

        .format-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
          margin-bottom: 24px;
        }

        .format-chip {
          background: var(--card);
          border: 1px solid var(--input-border);
          border-radius: 8px;
          padding: 16px;
          cursor: pointer;
          transition: all 0.2s ease;
          text-align: center;
          font-weight: 500;
          color: var(--text);
        }

        .format-chip:hover {
          background: var(--surface);
        }

        .format-chip.selected {
          background: var(--btn-bg);
          border-color: var(--primary);
          color: white;
        }

        .convert-btn {
          width: 100%;
          background: var(--btn-bg);
          border: none;
          color: white;
          padding: 14px;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          margin-bottom: 16px;
          transition: all 0.2s ease;
        }

        .convert-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .convert-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
        }

        .sample-btn {
          width: 100%;
          background: transparent;
          border: 1px solid var(--input-border);
          color: var(--muted);
          padding: 8px;
          border-radius: 6px;
          font-size: 12px;
          cursor: pointer;
          margin-bottom: 24px;
        }

        .action-row {
          display: flex;
          gap: 12px;
          margin-bottom: 24px;
        }

        .export-btn {
          flex: 1;
          background: var(--surface);
          border: 1px solid var(--input-border);
          color: var(--text);
          padding: 12px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
        }

        .push-btn {
          flex: 1;
          background: var(--btn-bg);
          border: none;
          color: white;
          padding: 12px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
        }

        .input-group {
          margin-bottom: 16px;
        }

        .input-label {
          display: block;
          font-size: 12px;
          color: var(--muted);
          margin-bottom: 6px;
        }

        .input-field {
          width: 100%;
          background: var(--surface);
          border: 1px solid var(--input-border);
          color: var(--text);
          padding: 12px;
          border-radius: 8px;
          font-size: 14px;
        }

        .input-field::placeholder {
          color: var(--muted);
        }

        .push-final-btn {
          width: 100%;
          background: var(--btn-bg);
          border: none;
          color: white;
          padding: 14px;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
        }

        #file { display: none; }

        .hidden { display: none !important; }

        #notification{ 
          display: none; 
          position: fixed; 
          left: 50%; 
          transform: translateX(-50%); 
          top: 18px; 
          padding: 10px 16px; 
          border-radius: 8px; 
          color: white; 
          font-weight: 600; 
          z-index: 999;
          font-size: 14px;
        }

        .notification-success {
          background: var(--success);
        }

        .notification-error {
          background: var(--danger);
        }
      </style>
    </head>
    <body>
      <div id="notification"></div>
      <div class="container">
        <div class="header">
          <div class="logo-section">
            <div class="logo">DT</div>
            <div class="title-section">
              <div class="h-title">Design Token Converter</div>
              <div class="h-sub">Convert Figma tokens to CSS, Dart, Kotlin, SwiftUI</div>
            </div>
          </div>
          <div class="header-actions">
            <button id="themeToggle" class="theme-toggle">ðŸŒ™</button>
            <button id="closeBtn" class="close-btn">âœ–</button>
          </div>
        </div>

        <div class="drop-zone" id="dropzone">
          <h3>Drop a JSON file</h3>
          <p>or click to choose â€” single file only</p>
          <button class="choose-btn" id="browse">Choose file</button>
          <input id="file" type="file" accept="application/json" />
          <div id="fileCardArea"></div>
        </div>

        <div class="format-grid">
          <div class="format-chip" id="chip-css">
            <span>CSS</span>
            <input id="f-css" type="checkbox" style="display: none;">
          </div>
          <div class="format-chip" id="chip-dart">
            <span>Dart</span>
            <input id="f-dart" type="checkbox" style="display: none;">
          </div>
          <div class="format-chip" id="chip-kotlin">
            <span>Kotlin</span>
            <input id="f-kotlin" type="checkbox" style="display: none;">
          </div>
          <div class="format-chip" id="chip-swift">
            <span>SwiftUI</span>
            <input id="f-swift" type="checkbox" style="display: none;">
          </div>
        </div>

        <button id="convert" class="convert-btn">Convert</button>

        <button id="sampleJson" class="sample-btn">
          ðŸ“‹ Load Sample JSON
        </button>

        <div class="action-row">
          <button id="export" class="export-btn">Export ZIP</button>
          <button id="push" class="push-btn">Push to GitHub</button>
        </div>

        <div class="input-group">
          <label class="input-label">GitHub Personal Access Token</label>
          <input id="pat" class="input-field" placeholder="ghp_xxxxxxxxxxxxxxxxx" />
        </div>

        <div class="input-group">
          <label class="input-label">Repository URL</label>
          <input id="repo" class="input-field" placeholder="https://github.com/username/repo" />
        </div>

        <button id="pushFinal" class="push-final-btn">Push to GitHub</button>
      </div>

      <script>
        // Theme handling
        const themeToggle = document.getElementById('themeToggle');
        const closeBtn = document.getElementById('closeBtn');
        const browse = document.getElementById('browse');
        const fileInput = document.getElementById('file');
        const drop = document.getElementById('dropzone');
        const fileCardArea = document.getElementById('fileCardArea');
        const convert = document.getElementById('convert');
        const exportBtn = document.getElementById('export');
        const pushBtn = document.getElementById('push');
        const pushFinalBtn = document.getElementById('pushFinal');
        const sampleJsonBtn = document.getElementById('sampleJson');

        function setTheme(theme){
          if (theme === 'light') {
            document.documentElement.setAttribute('data-theme','light');
            themeToggle.textContent = 'â˜€ï¸';
          } else {
            document.documentElement.removeAttribute('data-theme');
            themeToggle.textContent = 'ðŸŒ™';
          }
          localStorage.setItem('dtc-theme', theme);
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('dtc-theme') || 'dark';
        setTheme(savedTheme);

        themeToggle.onclick = () => {
          const currentTheme = document.documentElement.getAttribute('data-theme');
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          setTheme(newTheme);
        };

        closeBtn.onclick = () => {
          parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
        };

        // Format chips
        const chips = {
          css: document.getElementById('chip-css'),
          dart: document.getElementById('chip-dart'),
          kotlin: document.getElementById('chip-kotlin'),
          swift: document.getElementById('chip-swift')
        };

        Object.entries(chips).forEach(([k, el]) => {
          el.addEventListener('click', () => {
            const cb = document.getElementById('f-' + k);
            cb.checked = !cb.checked;
            el.classList.toggle('selected', cb.checked);
          });
        });

        // File handling
        browse.onclick = () => fileInput.click();
        
        drop.addEventListener('dragover', e => {
          e.preventDefault();
          drop.style.borderColor = 'var(--primary)';
        });
        
        drop.addEventListener('dragleave', e => {
          drop.style.borderColor = '';
        });
        
        drop.addEventListener('drop', e => {
          e.preventDefault();
          drop.style.borderColor = '';
          const f = e.dataTransfer.files[0];
          handleFile(f);
        });
        
        fileInput.onchange = e => handleFile(e.target.files[0]);

        let lastTokensJSON = null;
        let selectedFile = null;

        function handleFile(f) {
          if (!f) return;
          if (selectedFile) {
            showNotification('Only one file allowed, remove first', true);
            return;
          }
          selectedFile = f;
          renderFileCard(f);
          const reader = new FileReader();
          reader.onload = () => {
            lastTokensJSON = reader.result;
            const formats = [];
            if (document.getElementById('f-css').checked) formats.push('css');
            if (document.getElementById('f-dart').checked) formats.push('dart');
            if (document.getElementById('f-kotlin').checked) formats.push('kotlin');
            if (document.getElementById('f-swift').checked) formats.push('swift');
            if (formats.length) sendGenerate(formats);
          };
          reader.readAsText(f);
        }

        function renderFileCard(file) {
          if (!file) return;
          fileCardArea.innerHTML = `
            <div style="margin-top: 12px; padding: 8px; background: var(--surface); border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
              <span style="font-size: 12px; color: var(--text);">${escapeHtml(file.name)}</span>
              <button id="removeFile" style="background: none; border: none; color: var(--danger); cursor: pointer;">âœ–</button>
            </div>
          `;
          document.getElementById('removeFile').onclick = clearFile;
        }

        function clearFile() {
          selectedFile = null;
          lastTokensJSON = null;
          fileInput.value = '';
          fileCardArea.innerHTML = '';
        }

        // Sample JSON
        sampleJsonBtn.onclick = () => {
          const sampleTokens = {
            colors: {
              primary: { value: "#4f46e5" },
              secondary: { value: "#7c3aed" },
              success: { value: "#10b981" },
              danger: { value: "#ef4444" }
            },
            spacing: {
              xs: { value: "4px" },
              sm: { value: "8px" },
              md: { value: "16px" },
              lg: { value: "24px" }
            }
          };
          lastTokensJSON = JSON.stringify(sampleTokens, null, 2);
          showNotification('Sample JSON loaded');
        };

        // Convert
        convert.onclick = () => {
          if (!lastTokensJSON) {
            showNotification('Choose a JSON file first', true);
            return;
          }
          const formats = [];
          if (document.getElementById('f-css').checked) formats.push('css');
          if (document.getElementById('f-dart').checked) formats.push('dart');
          if (document.getElementById('f-kotlin').checked) formats.push('kotlin');
          if (document.getElementById('f-swift').checked) formats.push('swift');
          if (formats.length === 0) {
            showNotification('Select at least one output format', true);
            return;
          }
          sendGenerate(formats);
        };

        function sendGenerate(formats) {
          try {
            parent.postMessage({ pluginMessage: { type: 'generate', content: lastTokensJSON, formats } }, '*');
            showNotification('Generating outputs...');
          } catch (e) {
            showNotification('Failed to send generate message: ' + (e instanceof Error ? e.message : String(e)), true);
          }
        }

        // Export and Push handlers
        exportBtn.onclick = () => {
          if (!window._outputs) {
            showNotification('Convert first', true);
            return;
          }
          parent.postMessage({ pluginMessage: { type: 'export-zip' } }, '*');
        };

        pushBtn.onclick = pushFinalBtn.onclick = async () => {
          const pat = document.getElementById('pat').value.trim();
          const repo = document.getElementById('repo').value.trim();
          if (!pat) {
            showNotification('Enter GitHub token', true);
            return;
          }
          if (!repo) {
            showNotification('Enter repository URL', true);
            return;
          }
          if (!window._outputs) {
            showNotification('Convert first', true);
            return;
          }
          try {
            const res = await pushToGitHub({ pat, repo, files: window._outputs });
            showNotification('Push complete');
          } catch (e) {
            showNotification('Push failed: ' + (e instanceof Error ? e.message : String(e)), true);
          }
        };

        // Message handling
        window.onmessage = (event) => {
          const msg = event.data.pluginMessage;
          if (!msg) return;
          if (msg.type === 'generated') {
            window._outputs = msg.files || {};
            showNotification('Generation complete');
          }
          if (msg.type === 'generate-error') {
            showNotification('Generation error: ' + msg.error, true);
          }
        };

        // Helper functions
        function pushToGitHub({ pat, repo, files }) {
          return (async function() {
            let match = repo.match(/github.com\/(.+?)\/?(\.git)?$/);
            let path = repo;
            if (match) path = match[1];
            const apiBase = `https://api.github.com/repos/${path}`;
            const headers = { 'Authorization': 'token ' + pat, 'Content-Type': 'application/json' };
            const results = [];
            for (const name of Object.keys(files)) {
              const content = files[name];
              const filePath = `design-tokens/${name}.${name === 'css' ? 'css' : (name === 'dart' ? 'dart' : (name === 'kotlin' ? 'kt' : 'swift'))}`;
              const getRes = await fetch(apiBase + '/contents/' + encodeURIComponent(filePath), { headers });
              let sha = null;
              if (getRes.status === 200) {
                const j = await getRes.json();
                sha = j.sha;
              }
              const body = { message: `Add ${filePath} from design token converter`, content: btoa(unescape(encodeURIComponent(content))) };
              if (sha) body.sha = sha;
              const putRes = await fetch(apiBase + '/contents/' + encodeURIComponent(filePath), { method: 'PUT', headers, body: JSON.stringify(body) });
              const putJson = await putRes.json();
              results.push(putJson);
            }
            return { message: 'finished', details: results };
          })();
        }

        function escapeHtml(s) {
          return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]);
        }

        function showNotification(text, isError) {
          const el = document.getElementById('notification');
          el.textContent = text;
          el.className = isError ? 'notification-error' : 'notification-success';
          el.style.display = 'block';
          el.style.opacity = '1';
          setTimeout(() => {
            el.style.opacity = '0';
            setTimeout(() => el.style.display = 'none', 300);
          }, 2600);
        }
      </script>
    </body>
</html>